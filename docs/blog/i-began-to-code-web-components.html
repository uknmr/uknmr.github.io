<!doctype html>
<html lang="ja" class="font-serif leading-normal text-black">
  <head>
    <title>
      
        Web Components ことはじめ - uknmr
      
    </title>

    <meta name="viewport" content="width=device-width">

    <link rel="stylesheet" href="/css/style.min.css">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+JP:900|Noto+Serif+JP&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Caveat&text=uknmr&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Space+Mono:400i&text=acefinorstuvwy&display=swap">
    <script>
      (function(a,b,c){var d=a.history,e=document,f=navigator||{},g=localStorage,
      h=encodeURIComponent,i=d.pushState,k=function(){return Math.random().toString(36)},
      l=function(){return g.cid||(g.cid=k()),g.cid},m=function(r){var s=[];for(var t in r)
      r.hasOwnProperty(t)&&void 0!==r[t]&&s.push(h(t)+"="+h(r[t]));return s.join("&")},
      n=function(r,s,t,u,v,w,x){var z="https://www.google-analytics.com/collect",
      A=m({v:"1",ds:"web",aip:c.anonymizeIp?1:void 0,tid:b,cid:l(),t:r||"pageview",
      sd:c.colorDepth&&screen.colorDepth?screen.colorDepth+"-bits":void 0,dr:e.referrer||
      void 0,dt:e.title,dl:e.location.origin+e.location.pathname+e.location.search,ul:c.language?
      (f.language||"").toLowerCase():void 0,de:c.characterSet?e.characterSet:void 0,
      sr:c.screenSize?(a.screen||{}).width+"x"+(a.screen||{}).height:void 0,vp:c.screenSize&&
      a.visualViewport?(a.visualViewport||{}).width+"x"+(a.visualViewport||{}).height:void 0,
      ec:s||void 0,ea:t||void 0,el:u||void 0,ev:v||void 0,exd:w||void 0,exf:"undefined"!=typeof x&&
      !1==!!x?0:void 0});if(f.sendBeacon)f.sendBeacon(z,A);else{var y=new XMLHttpRequest;
      y.open("POST",z,!0),y.send(A)}};d.pushState=function(r){return"function"==typeof d.onpushstate&&
      d.onpushstate({state:r}),setTimeout(n,c.delay||10),i.apply(d,arguments)},n(),
      a.ma={trackEvent:function o(r,s,t,u){return n("event",r,s,t,u)},
      trackException:function q(r,s){return n("exception",null,null,null,null,r,s)}}})
      (window,"UA-41336003-3",{anonymizeIp:true,colorDepth:true,characterSet:true,screenSize:true,language:true});
    </script>
  </head>

  <body class="bg-grey-lightest max-w-md p-8 pt-0 m-auto">
    <header class="mt-20">
      <h1 class="-m-1 font-logo font-normal text-4xl leading-none">
        <a href="/" class="no-underline text-inherit">uknmr</a>
      </h1>
    </header>

    <main>
      
<article class="blog-body">
  <h1 class="mt-32 text-4xl font-sans font-black leading-tight tracking-tight">Web Components ことはじめ</h1>

  <footer class="mt-1 leading-none">
    <time datetime="2019-04-27T08:04:00.000+00:00" class="font-sans text-sm text-grey-darker">April 27, 2019</time>
  </footer>

  <p>もうずっと気になっていた、それこそ Bower をつかわないといけない Polymer の時代から気になっていたものの、なかなか投入するタイミングがわからず手を出さずにいた Web Components。</p>
<p><a href="https://game.auone.jp/styleguide/">仕事でつくったデザイン原則</a>から、さぁどうコンポーネントに落として展開しようかと考えるうち、Web Components という選択肢が上がってきた。</p>
<p><a href="https://blogs.windows.com/windowsexperience/2018/12/06/microsoft-edge-making-the-web-better-through-more-open-source-collaboration/">Edge の Chromium 化</a>も後押しして、今年は改めて Web Components 元年になるんじゃないかと思う。</p>
<p>ということで、<a href="https://css-tricks.com/an-introduction-to-web-components/">An Introduction to Web Components | CSS-Tricks</a> の写経から Web Components デビューすることにした。</p>
<h1>これが基本</h1>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token string">`&lt;h1>Hello world!&lt;/h1>`</span></span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'my-component'</span><span class="token punctuation">,</span> MyComponent<span class="token punctuation">)</span></span></code></pre>
<p>としておき <code>&lt;my-component&gt;&lt;/my-component&gt;</code> で呼び出すことができる。これが基本らしい。</p>
<p>すべての Custom Elements は何らかの形で <code>HTMLElement</code> を継承する必要があります。</p>
<p><code>connectedCallback()</code> は <a href="https://developer.mozilla.org/ja/docs/Web/Web_Components/Custom_Elements#Custom_element_methods">Custome Elements がもつライフサイクルメソッドのひとつ</a>で、その要素がドキュメントに挿入されたときに呼び出されます。</p>
<h1>Shadow DOM</h1>
<p>ドキュメント内のコンテンツを Light DOM と呼び、Shadow root にあるものを Shadow DOM と呼びます。</p>
<p>Light DOM で <code>document.querySelector('selector')</code> するように、Shadow DOM では <code>shadowRoot.querySelector('selector')</code> できます。<br>
このとき、Shadow DOM は Light DOM から選択することができません。</p>
<p><code>SVG</code> の <code>&lt;use&gt;</code> は Shadow DOM だよね。</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> shadowRoot <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'example'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attachShadow</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span><br><span class="highlight-line">  mode<span class="token punctuation">:</span> <span class="token string">'open'</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token string">`&lt;style></span><br><span class="highlight-line">  button {</span><br><span class="highlight-line">    background-color: grey;</span><br><span class="highlight-line">    padding: 5px;</span><br><span class="highlight-line">    color: white;</span><br><span class="highlight-line">  }</span><br><span class="highlight-line">&lt;/style></span><br><span class="highlight-line">&lt;button id="button">&lt;slot>&lt;/slot> button&lt;/button>`</span></span></span></code></pre>
<p><code>attachShadow()</code> は Shadow DOM を特定の要素に追加し、その Shadow root を返します。<br>
<code>mode: 'open'</code> はカプセル化モードを文字列で指定でき、<code>open</code> だと ShadowRoot オブジェクトにアクセスできるが、<code>'close'</code> だと <code>null</code> を返す。</p>
<p>これで <code>&lt;div id=example&gt;Shadom root example&lt;/div&gt;</code> とすれば</p>
<pre class="language-html"><code class="language-html"><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>example<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  #shadow-root (open)</span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"></span><br><span class="highlight-line">      <span class="token selector">button</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token property">background-color</span><span class="token punctuation">:</span> grey<span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token property">padding</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token punctuation">}</span></span><br><span class="highlight-line">    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">></span></span> button</span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  Shadow root sample</span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></span></code></pre>
<p>となり、<code>Shadow root sample</code> は <code>&lt;slot&gt;</code> に入れ込まれる。</p>
<p><img src="https://gyazo.com/d1fbc37b01a433ac158b9867d744f125.png" alt=""></p>
<p>こんな感じ。</p>
<h1>HTML Templates</h1>
<pre class="language-html"><code class="language-html"><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>book-template<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span> <span class="token entity" title="&mdash;">&amp;mdash;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>author<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>books<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span></span></code></pre>
<p>この <code>&lt;template&gt;</code> は表示されず <code>createDocumentFragment()</code> してたようなやつを HTML として持つことができる。</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'book-template'</span><span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token keyword">const</span> books <span class="token operator">=</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">    title<span class="token punctuation">:</span> <span class="token string">'The Great Gatsby'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    author<span class="token punctuation">:</span> <span class="token string">'F. Scott Fitzgerald'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">    title<span class="token punctuation">:</span> <span class="token string">'A Farewell to Arms'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    author<span class="token punctuation">:</span> <span class="token string">'Ernest Hemingway'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">{</span></span><br><span class="highlight-line">    title<span class="token punctuation">:</span> <span class="token string">'Catch 22'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    author<span class="token punctuation">:</span> <span class="token string">'Joseph Heller'</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line"><span class="token punctuation">]</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">books<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">book</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token comment">// Create an instance of the template content</span></span><br><span class="highlight-line">  <span class="token keyword">const</span> instance <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>fragment<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">// Add relevant content to the template</span></span><br><span class="highlight-line">  instance<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> book<span class="token punctuation">.</span>title</span><br><span class="highlight-line">  instance<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.author'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> book<span class="token punctuation">.</span>author</span><br><span class="highlight-line">  <span class="token comment">// Append the instance ot the DOM</span></span><br><span class="highlight-line">  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'books'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p><code>importNode()</code> は DocumentFragment や Node を複製するメソッドで、第一引数がインポートしたい DocumentFragment または Node、第二引数の boolean は第一引数で指定した externalNode の DOM サブツリーをすべてコピーするかどうか。</p>
<h1>さらに HTML Templates</h1>
<p><code>&lt;style&gt;</code> も <code>&lt;script&gt;</code> も HTML Templates の中にいれることができる。これは、なんでもできてしまうな。</p>
<pre class="language-html"><code class="language-html"><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>template<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></span><br><span class="highlight-line">    <span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'click-me'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style"><span class="token language-css"></span><br><span class="highlight-line">    <span class="token selector">#click-me</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token property">all</span><span class="token punctuation">:</span> unset<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">background</span><span class="token punctuation">:</span> tomato<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">border</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">font-family</span><span class="token punctuation">:</span> Helvetica<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">font-size</span><span class="token punctuation">:</span> 1.5rem<span class="token punctuation">;</span></span><br><span class="highlight-line">      <span class="token property">padding</span><span class="token punctuation">:</span> .5rem 1rem<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span></span><br><span class="highlight-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>click-me<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Log click event<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span></span><br><span class="highlight-line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span></span></code></pre>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> template <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p><a href="https://css-tricks.com/crafting-reusable-html-templates/">Crafting Reusable HTML Templates | CSS-Tricks</a> では HTML Templates で Dialog をつくるサンプルが書かれていた。</p>
<h1>再利用のために Custom Elements でやる</h1>
<p>Custom Elements のライフサイクルメソッド、<code>constractor()</code> は要素の必要最低限の設定につかい、<code>connectedCallback()</code> は要素にコンテンツを追加したりイベントを登録する、べつもの。</p>
<p><code>attributeChangedCallback()</code> は <code>observedAttributes()</code> に設定した属性が変更された場合に呼び出される。</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">observedAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function">attributeChangedCallback</span><span class="token punctuation">(</span><span class="token parameter">attrName<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> oldValue<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">[</span>attrName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> template <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">const</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>close<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.overlay'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>close<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function">disconnectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>close<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.overlay'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>close<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">get</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token keyword">set</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token parameter">isOpen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.wrapper'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">toggle</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> isOpen<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.wrapper'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'aria-hidden'</span><span class="token punctuation">,</span> <span class="token operator">!</span>isOpen<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>isOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>_wasFocused <span class="token operator">=</span> document<span class="token punctuation">.</span>activeElement</span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_watchEscape<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>_wasFocused <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wasFocused<span class="token punctuation">.</span>focus <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wasFocused<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      document<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_watchEscape<span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function-variable function">close</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>open <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>open <span class="token operator">=</span> <span class="token boolean">false</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    <span class="token keyword">const</span> closeEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomEvent</span><span class="token punctuation">(</span><span class="token string">'dialog-closed'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>closeEvent<span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token function-variable function">_watchEscape</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>key <span class="token operator">===</span> <span class="token string">'Escape'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">customElements<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'my-component'</span><span class="token punctuation">,</span> MyComponent<span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'launch-dialog'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'my-component'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>open <span class="token operator">=</span> <span class="token boolean">true</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></code></pre>
<p><code>disconnectedCallback()</code> は <code>connectedCallback()</code> の逆で要素から削除されるときに呼び出される。</p>
<h1>Shadow DOM をどうスタイリングするか</h1>
<p><code>innerHTML</code> に <code>&lt;style&gt;</code> を差し込むのが唯一の確実な Shadow DOM のスタイリング方法らしい。<br>
<code>:host</code> は Shadow root に対してスタイリングできる。</p>
<p>このスタイルタグ内ではカスタムプロパティがつかえるので Shadow DOM 外からスタイルを変えられる。<br>
<code>:host</code> でカスタムプロパティを上書きした場合は、カスケーディングされるのでもちろん <code>:host</code> が勝つ。</p>
<p><code>:host</code> は <a href="https://codepen.io/calebdwilliams/pen/eXJZza">CSS custom properties and shadow DOM</a> を見て理解したし、<code>Constructable Stylesheets</code> は <a href="https://codepen.io/calebdwilliams/pen/eXJZza">CSS custom properties and shadow DOM</a> を見るとよさそう。</p>

</article>

    </main>

    <footer class="mt-32">
      <p class="text-xs text-center">このサイトは <a href="https://www.11ty.io/">Eleventy</a> でつくり、<a href="https://pages.github.com/">GitHub Pages</a> にのせています。<a href="https://github.com/uknmr/uknmr.github.io">GitHub</a> にソースコードがあります。</p>
    </footer>
  </body>
</html>